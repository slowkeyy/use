<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>任務管理面板</title>
  
  <!-- 引入 Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 引入 Lucide 圖標庫 -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #E2E8F0; border-radius: 10px; }
  </style>
</head>
<body class="min-h-screen bg-[#F8FAFC] p-6 md:p-12 text-slate-900">
  
  <div id="app" class="max-w-7xl mx-auto">
    <!-- 內容將由 JavaScript 動態渲染 -->
  </div>

  <script>
    // --- 核心資料狀態 ---
    let projects = [
      {
        id: 1,
        title: "品牌官網設計",
        description: "包含 UI/UX 設計與前端開發流程",
        tasks: [
          { 
            id: 101, 
            text: "繪製 Wireframe", 
            completed: true, 
            subNotes: [
              { id: 1, text: "需要包含行動端佈局" },
              { id: 2, text: "確認導航列的交互邏輯" }
            ] 
          },
          { id: 102, text: "設計視覺風格指南", completed: true, subNotes: [] },
          { 
            id: 103, 
            text: "React 元件開發", 
            completed: false, 
            subNotes: [
              { id: 3, text: "優先開發 Navigation 和 Hero Section" }
            ] 
          }
        ],
        notes: [
          { id: 1, text: "客戶希望主色調用深藍色", time: "14:30" }
        ]
      }
    ];

    let view = 'dashboard'; 
    let selectedProjectId = null;
    let isModalOpen = false;
    let isEditingTitle = false;

    // Modal 表單暫存資料
    let modalData = {
      title: "",
      tasks: [{ text: "", subNotes: [""] }]
    };

    // --- 通用邏輯 ---
    function calculateProgress(tasks) {
      if (tasks.length === 0) return 0;
      const completedCount = tasks.filter(t => t.completed).length;
      return Math.round((completedCount / tasks.length) * 100);
    }

    // --- 重新渲染畫面 ---
    function render() {
      const app = document.getElementById('app');
      let html = '';

      if (view === 'dashboard') {
        html = renderDashboard();
      } else if (view === 'detail') {
        html = renderDetail();
      }

      if (isModalOpen) {
        html += renderModal();
      }

      app.innerHTML = html;
      
      // 重新繪製 Lucide 圖標
      lucide.createIcons();
    }

    // --- 渲染：控制台視圖 ---
    function renderDashboard() {
      let cardsHtml = projects.map(project => {
        const progress = calculateProgress(project.tasks);
        return `
          <div onclick="openProject(${project.id})" class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100 hover:shadow-2xl hover:-translate-y-1 transition-all cursor-pointer group relative">
            <button onclick="deleteProject(${project.id}, event)" class="absolute top-6 right-6 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all z-10">
              <i data-lucide="trash-2" width="18" height="18"></i>
            </button>

            <div class="flex justify-between items-start mb-6">
              <div class="w-16 h-16 relative">
                <svg class="w-full h-full transform -rotate-90">
                  <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="5" fill="transparent" class="text-slate-100"></circle>
                  <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="5" fill="transparent"
                    stroke-dasharray="${2 * Math.PI * 28}"
                    stroke-dashoffset="${2 * Math.PI * 28 * (1 - progress / 100)}"
                    stroke-linecap="round"
                    class="text-indigo-600 transition-all duration-700"></circle>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center text-sm font-black text-slate-800">
                  ${progress}%
                </div>
              </div>
            </div>

            <h3 class="text-xl font-bold text-slate-800 mb-2 group-hover:text-indigo-600 transition-colors">${project.title}</h3>
            <p class="text-slate-400 text-sm mb-6">${project.tasks.length} 個待辦事項</p>

            <div class="flex items-center justify-between pt-6 border-t border-slate-50">
              <div class="flex items-center gap-2 text-indigo-600 font-bold text-sm">
                進入管理 <i data-lucide="chevron-right" width="16" height="16"></i>
              </div>
            </div>
          </div>
        `;
      }).join('');

      return `
        <div class="animate-in fade-in duration-500">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
            <div>
              <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">我的任務看板</h1>
              <p class="text-slate-500 mt-2 flex items-center gap-2">
                <i data-lucide="clock" width="16" height="16"></i> 目前有 ${projects.length} 個活躍專案
              </p>
            </div>
            <button onclick="openModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-2xl shadow-xl shadow-indigo-200 transition-all active:scale-95 flex items-center gap-2 font-bold">
              <i data-lucide="plus" width="20" height="20"></i> 建立新專案
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            ${cardsHtml}
          </div>
        </div>
      `;
    }

    // --- 渲染：詳情視圖 ---
    function renderDetail() {
      const project = projects.find(p => p.id === selectedProjectId);
      if (!project) return '';
      
      const progress = calculateProgress(project.tasks);

      // 標題區塊
      let titleHtml = '';
      if (isEditingTitle) {
        titleHtml = `
          <div class="flex items-center gap-2">
            <input id="edit-title-input" class="text-4xl font-black text-slate-900 border-b-2 border-indigo-600 focus:outline-none w-full bg-transparent" value="${project.title}" autofocus onkeydown="if(event.key==='Enter') saveProjectTitle()">
            <button onclick="saveProjectTitle()" class="p-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700">
              <i data-lucide="check" width="24" height="24"></i>
            </button>
          </div>
        `;
      } else {
        titleHtml = `
          <div class="flex items-center gap-3 group/title">
            <h2 class="text-4xl font-black text-slate-900">${project.title}</h2>
            <button onclick="editTitle()" class="p-2 text-slate-300 hover:text-indigo-600 opacity-0 group-hover/title:opacity-100 transition-all">
              <i data-lucide="edit-3" width="20" height="20"></i>
            </button>
          </div>
        `;
      }

      // 任務列表
      let tasksHtml = project.tasks.map(task => {
        let subNotesHtml = task.subNotes.map((sn, idx) => `
          <div class="flex items-start gap-3 group/sn bg-slate-50/50 p-2 rounded-xl border border-transparent hover:border-slate-200 transition-all">
            <div class="mt-1 flex items-center justify-center w-5 h-5 bg-indigo-100 text-indigo-600 rounded text-[10px] font-bold shrink-0">${idx + 1}</div>
            <p class="text-sm text-slate-600 leading-relaxed flex-1">${sn.text}</p>
            <button onclick="deleteSubNoteInDetail(${task.id}, ${sn.id})" class="text-slate-300 hover:text-red-400 opacity-0 group-hover/sn:opacity-100 transition-opacity p-1">
              <i data-lucide="x" width="14" height="14"></i>
            </button>
          </div>
        `).join('');

        return `
          <div class="group flex flex-col p-6 rounded-3xl border transition-all ${task.completed ? 'bg-emerald-50/20 border-emerald-100' : 'bg-white border-slate-100 hover:border-indigo-100 shadow-sm shadow-slate-100'}">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4 cursor-pointer flex-1" onclick="toggleTask(${task.id})">
                ${task.completed ? 
                  `<div class="bg-emerald-500 rounded-full p-1"><i data-lucide="check" width="14" height="14" class="text-white"></i></div>` : 
                  `<i data-lucide="circle" width="22" height="22" class="text-slate-300"></i>`
                }
                <span class="text-lg ${task.completed ? 'text-slate-400 line-through' : 'text-slate-800 font-bold'}">${task.text}</span>
              </div>
              <button onclick="deleteTaskInDetail(${task.id}, event)" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-2">
                <i data-lucide="trash-2" width="18" height="18"></i>
              </button>
            </div>

            <div class="mt-4 ml-10 space-y-3">
              ${subNotesHtml}
              <div class="flex items-center gap-2 mt-4 bg-white rounded-xl border border-slate-100 p-1 focus-within:border-indigo-200 transition-all">
                <i data-lucide="sticky-note" width="14" height="14" class="ml-3 text-slate-400"></i>
                <input id="subnote-input-${task.id}" class="flex-1 bg-transparent border-none text-sm py-2 px-2 focus:ring-0 focus:outline-none text-slate-600 placeholder:text-slate-300 italic" placeholder="新增子註解並按 Enter..." onkeydown="if(event.key==='Enter') addSubNoteInDetail(${task.id})">
                <button onclick="addSubNoteInDetail(${task.id})" class="mr-1 p-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition-colors">
                  <i data-lucide="send" width="14" height="14"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // 全局備忘錄列表
      let notesHtml = project.notes.map(note => `
        <div class="bg-white/10 p-4 rounded-2xl relative group border border-white/5">
          <p class="text-sm leading-relaxed mb-2 pr-4">${note.text}</p>
          <div class="text-[10px] text-indigo-400 font-mono">${note.time}</div>
        </div>
      `).join('');

      return `
        <div class="animate-in fade-in duration-500 max-w-5xl mx-auto">
          <button onclick="goToDashboard()" class="flex items-center gap-2 text-slate-500 hover:text-indigo-600 mb-8 font-medium transition-colors group">
            <i data-lucide="arrow-left" width="20" height="20" class="group-hover:-translate-x-1 transition-transform"></i> 返回控制台
          </button>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
              <div class="bg-white rounded-[2.5rem] p-10 shadow-sm border border-slate-100">
                <div class="flex justify-between items-start mb-10">
                  <div class="flex-1 mr-4">
                    ${titleHtml}
                  </div>
                  <div class="text-right">
                    <div class="text-3xl font-black text-indigo-600">${progress}%</div>
                    <div class="text-slate-400 text-xs font-bold uppercase tracking-wider">Progress</div>
                  </div>
                </div>

                <div class="flex gap-3 mb-8">
                  <input id="detail-task-input" type="text" placeholder="新增一項待辦任務..." class="flex-1 bg-slate-50 border-none outline-none rounded-2xl px-6 py-4 focus:ring-2 focus:ring-indigo-500/20 text-slate-700 font-medium" onkeydown="if(event.key==='Enter') addTaskInDetail()">
                  <button onclick="addTaskInDetail()" class="bg-indigo-600 hover:bg-indigo-700 text-white w-14 h-14 rounded-2xl flex items-center justify-center transition-all active:scale-90 shadow-lg shadow-indigo-100">
                    <i data-lucide="plus-circle" width="24" height="24"></i>
                  </button>
                </div>

                <div class="space-y-4">
                  ${tasksHtml}
                </div>
              </div>
            </div>

            <div class="bg-slate-900 rounded-[2.5rem] p-8 text-white shadow-xl min-h-[500px] flex flex-col">
              <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                <i data-lucide="message-square" width="20" height="20" class="text-indigo-400"></i> 專案控制台備忘
              </h3>
              
              <div class="flex-1 space-y-4 overflow-y-auto pr-2 mb-6 custom-scrollbar">
                ${notesHtml}
              </div>

              <div class="relative mt-auto">
                <input id="global-note-input" type="text" placeholder="新增全局註解..." class="w-full bg-white/10 border border-white/10 outline-none rounded-xl py-3 pl-4 pr-12 text-sm focus:ring-2 focus:ring-indigo-500 transition-all" onkeydown="if(event.key==='Enter') addNote()">
                <button onclick="addNote()" class="absolute right-2 top-1.5 p-1.5 bg-indigo-500 hover:bg-indigo-600 rounded-lg">
                  <i data-lucide="send" width="16" height="16"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // --- 渲染：新增專案 Modal ---
    function renderModal() {
      let tasksHtml = modalData.tasks.map((task, taskIdx) => {
        let subNotesHtml = task.subNotes.map((sn, snIdx) => `
          <div class="flex gap-2 items-center">
            <i data-lucide="sticky-note" width="12" height="12" class="text-indigo-400 shrink-0"></i>
            <input id="modal-sn-${taskIdx}-${snIdx}" placeholder="子註解 ${snIdx + 1}..." class="flex-1 bg-white border border-slate-100 outline-none rounded-lg px-3 py-2 text-xs text-slate-600 focus:ring-1 focus:ring-indigo-500" value="${sn}">
            ${task.subNotes.length > 1 ? `
              <button onclick="removeModalSubNote(${taskIdx}, ${snIdx})" class="text-slate-200 hover:text-red-400">
                <i data-lucide="x" width="12" height="12"></i>
              </button>
            ` : ''}
          </div>
        `).join('');

        return `
          <div class="space-y-4 p-6 bg-slate-50/50 rounded-3xl border border-slate-100">
            <div class="flex gap-3 items-center">
              <div class="w-8 h-8 rounded-lg bg-indigo-600 text-white flex items-center justify-center font-bold text-sm shrink-0">${taskIdx + 1}</div>
              <input id="modal-task-${taskIdx}" placeholder="任務名稱..." class="flex-1 bg-white border border-slate-200 outline-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all font-bold" value="${task.text}">
              ${modalData.tasks.length > 1 ? `
                <button onclick="removeModalTask(${taskIdx})" class="text-slate-300 hover:text-red-500 transition-colors">
                  <i data-lucide="trash-2" width="18" height="18"></i>
                </button>
              ` : ''}
            </div>
            <div class="ml-11 space-y-2">
              ${subNotesHtml}
              <button onclick="addModalSubNote(${taskIdx})" class="text-[10px] font-bold text-indigo-500 hover:text-indigo-700 flex items-center gap-1">
                <i data-lucide="plus" width="10" height="10"></i> 新增子註解欄位
              </button>
            </div>
          </div>
        `;
      }).join('');

      return `
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-[2.5rem] w-full max-w-2xl shadow-2xl animate-in fade-in zoom-in duration-300 max-h-[90vh] flex flex-col overflow-hidden">
            <div class="p-8 border-b border-slate-50 flex justify-between items-center bg-indigo-50/30">
              <h2 class="text-2xl font-black text-slate-800">規劃新計畫</h2>
              <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" width="24" height="24"></i></button>
            </div>
            
            <div class="p-8 space-y-8 overflow-y-auto custom-scrollbar flex-1">
              <div>
                <label class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 block">專案基本資訊</label>
                <input id="modal-title" type="text" placeholder="輸入專案名稱..." class="w-full px-6 py-4 rounded-2xl bg-slate-50 border-none outline-none text-lg font-bold focus:ring-2 focus:ring-indigo-500/20 transition-all" value="${modalData.title}">
              </div>
              <div class="space-y-6">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-widest block">初始任務與註解列表</label>
                ${tasksHtml}
                <button onclick="addModalTask()" class="w-full py-4 rounded-2xl border-2 border-dashed border-slate-200 text-slate-400 hover:border-indigo-300 hover:text-indigo-600 transition-all font-bold text-sm flex items-center justify-center gap-2">
                  <i data-lucide="list-todo" width="18" height="18"></i> 增加下一個任務
                </button>
              </div>
            </div>
            <div class="p-8 border-t border-slate-50 bg-white shadow-[0_-10px_20px_rgba(0,0,0,0.02)]">
              <button onclick="submitNewProject()" class="w-full py-4 rounded-2xl font-bold bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition-all active:scale-[0.98]">
                正式開始計畫
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // --- 互動邏輯綁定 ---

    // 同步 Modal 表單 DOM 內容至 modalData 物件
    function syncModalData() {
      if (!isModalOpen) return;
      const titleInput = document.getElementById('modal-title');
      if (titleInput) modalData.title = titleInput.value;

      modalData.tasks.forEach((task, taskIdx) => {
        const taskInput = document.getElementById(`modal-task-${taskIdx}`);
        if (taskInput) task.text = taskInput.value;

        task.subNotes.forEach((sn, snIdx) => {
          const snInput = document.getElementById(`modal-sn-${taskIdx}-${snIdx}`);
          if (snInput) task.subNotes[snIdx] = snInput.value;
        });
      });
    }

    window.openModal = function() {
      modalData = { title: "", tasks: [{ text: "", subNotes: [""] }] };
      isModalOpen = true;
      render();
    };

    window.closeModal = function() {
      isModalOpen = false;
      render();
    };

    window.addModalTask = function() {
      syncModalData();
      modalData.tasks.push({ text: "", subNotes: [""] });
      render();
    };

    window.removeModalTask = function(index) {
      syncModalData();
      modalData.tasks.splice(index, 1);
      render();
    };

    window.addModalSubNote = function(taskIndex) {
      syncModalData();
      modalData.tasks[taskIndex].subNotes.push("");
      render();
    };

    window.removeModalSubNote = function(taskIndex, snIndex) {
      syncModalData();
      modalData.tasks[taskIndex].subNotes.splice(snIndex, 1);
      render();
    };

    window.submitNewProject = function() {
      syncModalData();
      if (!modalData.title.trim()) return;

      const newProject = {
        id: Date.now(),
        title: modalData.title,
        description: "新建立的專案項目",
        tasks: modalData.tasks
          .filter(t => t.text.trim() !== "")
          .map((t, index) => ({
            id: Date.now() + index,
            text: t.text,
            completed: false,
            subNotes: t.subNotes.filter(sn => sn.trim() !== "").map((sn, i) => ({ id: Date.now() + index + i + 100, text: sn }))
          })),
        notes: []
      };

      projects.push(newProject);
      isModalOpen = false;
      render();
    };

    window.openProject = function(id) {
      selectedProjectId = id;
      view = 'detail';
      isEditingTitle = false;
      render();
    };

    window.goToDashboard = function() {
      view = 'dashboard';
      selectedProjectId = null;
      render();
    };

    window.deleteProject = function(id, e) {
      e.stopPropagation(); // 避免觸發進入專案的事件
      projects = projects.filter(p => p.id !== id);
      render();
    };

    window.editTitle = function() {
      isEditingTitle = true;
      render();
    };

    window.saveProjectTitle = function() {
      const input = document.getElementById('edit-title-input');
      if (input && input.value.trim() !== "") {
        const project = projects.find(p => p.id === selectedProjectId);
        if (project) project.title = input.value.trim();
      }
      isEditingTitle = false;
      render();
    };

    window.toggleTask = function(taskId) {
      const project = projects.find(p => p.id === selectedProjectId);
      if (project) {
        const task = project.tasks.find(t => t.id === taskId);
        if (task) task.completed = !task.completed;
        render();
      }
    };

    window.addTaskInDetail = function() {
      const input = document.getElementById('detail-task-input');
      const text = input.value.trim();
      if (!text) return;

      const project = projects.find(p => p.id === selectedProjectId);
      if (project) {
        project.tasks.push({ id: Date.now(), text: text, completed: false, subNotes: [] });
        render();
      }
    };

    window.deleteTaskInDetail = function(taskId, e) {
      e.stopPropagation();
      const project = projects.find(p => p.id === selectedProjectId);
      if (project) {
        project.tasks = project.tasks.filter(t => t.id !== taskId);
        render();
      }
    };

    window.addSubNoteInDetail = function(taskId) {
      const input = document.getElementById(`subnote-input-${taskId}`);
      const text = input.value.trim();
      if (!text) return;

      const project = projects.find(p => p.id === selectedProjectId);
      if (project) {
        const task = project.tasks.find(t => t.id === taskId);
        if (task) {
          task.subNotes.push({ id: Date.now(), text: text });
          render();
        }
      }
    };

    window.deleteSubNoteInDetail = function(taskId, subNoteId) {
      const project = projects.find(p => p.id === selectedProjectId);
      if (project) {
        const task = project.tasks.find(t => t.id === taskId);
        if (task) {
          task.subNotes = task.subNotes.filter(sn => sn.id !== subNoteId);
          render();
        }
      }
    };

    window.addNote = function() {
      const input = document.getElementById('global-note-input');
      const text = input.value.trim();
      if (!text) return;

      const now = new Date();
      const timeString = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
      
      const project = projects.find(p => p.id === selectedProjectId);
      if (project) {
        project.notes.push({ id: Date.now(), text: text, time: timeString });
        render();
      }
    };

    // --- 初始化應用程式 ---
    render();
  </script>
</body>
</html>
